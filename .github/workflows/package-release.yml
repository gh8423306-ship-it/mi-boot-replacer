name: "NodeJs with Release"

# This workflow is for maintainers/developers only

# 1. Update module/module.prop with the new version
# 2. Edit CHANGELOG.md
# 3. Run

run-name: "Release: v${{ inputs.version }} (${{ inputs.release_type }})"

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.8)'
        required: true
        type: string
      title:
        description: 'Release title (e.g., v1.0.8)'
        required: true
        type: string
      release_type:
        description: 'Release type'
        required: true
        default: 'release'
        type: choice
        options:
          - 'release'
          - 'pre-release'
          - 'draft'

jobs:
  create-release:
    runs-on: ubuntu-latest
    name: Create Release
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Validate version format
        run: |
          VERSION="${{ github.event.inputs.version }}"

          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Version must be in format X.Y.Z (e.g., 1.0.8)"
            exit 1
          fi

          echo "Version: $VERSION"

      - name: Create module ZIP
        id: create_zip
        run: |
          VERSION="${{ github.event.inputs.version }}"
          ZIP_NAME="mi-boot-replacer-$VERSION.zip"

          cd module

          # Create ZIP with stored (no compression) mode for bootanimation compatibility
          echo "Creating ZIP with stored (no compression) mode..."
          zip -r -0 "../$ZIP_NAME" . -x "*.git*"

          cd ..

          # Get zip size
          ZIP_SIZE=$(du -h "$ZIP_NAME" | cut -f1)

          echo "zip_name=$ZIP_NAME" >> $GITHUB_OUTPUT
          echo "zip_size=$ZIP_SIZE" >> $GITHUB_OUTPUT

          echo ""
          echo "Created: $ZIP_NAME ($ZIP_SIZE)"
          echo ""
          echo "ZIP contents:"
          unzip -l "$ZIP_NAME"

      - name: Create GitHub Release
        id: create_release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ github.event.inputs.version }}"
          TAG="v$VERSION"
          TITLE="${{ github.event.inputs.title }}"
          RELEASE_TYPE="${{ github.event.inputs.release_type }}"
          ZIP_NAME="${{ steps.create_zip.outputs.zip_name }}"

          # Check if CHANGELOG.md exists
          if [ ! -f "CHANGELOG.md" ]; then
            echo "Error: CHANGELOG.md not found!"
            echo "Please create CHANGELOG.md with your release notes before running this workflow."
            exit 1
          fi

          # Get the previous release tag for changelog link
          PREV_TAG=$(gh release list --repo ${{ github.repository }} --exclude-drafts --limit 1 --json tagName -q '.[0].tagName' 2>/dev/null || echo "")

          # Copy release notes and append changelog link
          cp CHANGELOG.md changelog.md

          if [ -n "$PREV_TAG" ]; then
            CHANGELOG_URL="https://github.com/${{ github.repository }}/compare/${PREV_TAG}...${TAG}"
            echo "" >> changelog.md
            echo "---" >> changelog.md
            echo "**Full Changelog**: ${CHANGELOG_URL}" >> changelog.md
          fi

          # Build release flags
          FLAGS=""
          if [ "$RELEASE_TYPE" = "pre-release" ]; then
            FLAGS="--prerelease"
          elif [ "$RELEASE_TYPE" = "draft" ]; then
            FLAGS="--draft"
          fi

          echo "Creating release..."
          echo "  Tag: $TAG"
          echo "  Title: $TITLE"
          echo "  Type: $RELEASE_TYPE"
          if [ -n "$PREV_TAG" ]; then
            echo "  Previous tag: $PREV_TAG"
          fi

          # Create the release with the ZIP attached
          gh release create "$TAG" "$ZIP_NAME" \
            --title "$TITLE" \
            --notes-file changelog.md \
            $FLAGS

          echo "Release created successfully!"
          echo "release_url=https://github.com/${{ github.repository }}/releases/tag/$TAG" >> $GITHUB_OUTPUT

      - name: Set up Node.js
        if: ${{ github.event.inputs.release_type == 'release' }}
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Update update.json
        if: ${{ github.event.inputs.release_type == 'release' }}
        run: |
          set -e
          VERSION="v${{ github.event.inputs.version }}"
          VERSION_CODE=$(echo "$VERSION" | tr -dc '0-9')

          if [ -z "$VERSION_CODE" ] || ! [[ "$VERSION_CODE" =~ ^[0-9]+$ ]]; then
            echo "Error: Invalid version code: $VERSION_CODE"
            exit 1
          fi

          VERSION_NO_V="${{ github.event.inputs.version }}"
          ZIP_URL="https://github.com/${{ github.repository }}/releases/latest/download/mi-boot-replacer-${VERSION_NO_V}.zip"
          CHANGELOG_URL="https://raw.githubusercontent.com/${{ github.repository }}/main/README.md"

          echo "Updating update.json..."
          echo "  Version: $VERSION"
          echo "  Version Code: $VERSION_CODE"
          echo "  ZIP URL: $ZIP_URL"

          jq -n \
            --arg version "$VERSION" \
            --argjson versionCode "$VERSION_CODE" \
            --arg zipUrl "$ZIP_URL" \
            --arg changelog "$CHANGELOG_URL" \
            '{
              version: $version,
              versionCode: $versionCode,
              zipUrl: $zipUrl,
              changelog: $changelog
            }' > update.json

          echo ""
          echo "Updated update.json:"
          cat update.json

      - name: Commit and push update.json
        if: ${{ github.event.inputs.release_type == 'release' }}
        run: |
          set -e
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add update.json
          git commit -m "chore: update JSON for release v${{ github.event.inputs.version }}"
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate build summary
        run: |
          VERSION="${{ github.event.inputs.version }}"
          RELEASE_TYPE="${{ github.event.inputs.release_type }}"

          cat << EOF >> $GITHUB_STEP_SUMMARY
          # Release Created Successfully

          ## Release Details

          | Property | Value |
          |----------|-------|
          | **Tag** | v$VERSION |
          | **Title** | ${{ github.event.inputs.title }} |
          | **Type** | $RELEASE_TYPE |
          | **File** | \`${{ steps.create_zip.outputs.zip_name }}\` |
          | **Size** | ${{ steps.create_zip.outputs.zip_size }} |

          ## Links

          - [View Release](${{ steps.create_release.outputs.release_url }})
          EOF

          if [ "$RELEASE_TYPE" = "release" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## Auto-Updated" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- \`update.json\` has been automatically updated and pushed to main" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## Note" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- \`update.json\` was NOT updated (only updated for full releases)" >> $GITHUB_STEP_SUMMARY
          fi
